import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.resolve(__dirname, '..');
const shoesDir = path.join(projectRoot, 'public', 'shoes');
const outputFile = path.join(projectRoot, 'src', 'data', 'image-manifest.ts');

function getShoeImagePaths(dirPath) {
  if (!fs.existsSync(dirPath)) return [];

  return fs
    .readdirSync(dirPath, { withFileTypes: true })
    .filter((entry) => entry.isFile())
    .map((entry) => entry.name)
    .filter((fileName) => /\.(webp|png|jpg|jpeg|avif|svg)$/i.test(fileName))
    .map((fileName) => `/shoes/${fileName}`)
    .sort((a, b) => a.localeCompare(b));
}

const imagePaths = getShoeImagePaths(shoesDir);

const fileContent = `// AUTO-GENERATED FILE. DO NOT EDIT MANUALLY.
// Generated by scripts/generate-image-manifest.mjs

export const AVAILABLE_SHOE_IMAGES = new Set<string>([
${imagePaths.map((imagePath) => `  '${imagePath}',`).join('\n')}
]);

export function hasShoeImage(imagePath: string): boolean {
  return AVAILABLE_SHOE_IMAGES.has(imagePath);
}
`;

fs.writeFileSync(outputFile, fileContent, 'utf8');
console.log(`[image-manifest] wrote ${imagePaths.length} entries -> ${path.relative(projectRoot, outputFile)}`);
