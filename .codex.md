# RunPick Codex Context (Current)

이 문서는 이 저장소를 수정하는 AI/Codex 에이전트를 위한 실전 가이드다.  
목표는 "빠르게 파악"이 아니라 "지금 코드의 실제 동작을 틀리지 않고 수정"하는 것이다.

## 1) Project Snapshot

- 서비스: 멀티브랜드 러닝화 카탈로그 + 5문항 추천 퀴즈
- 프레임워크: Next.js App Router (`next@16`) + React 19 + TypeScript
- 배포 모드: 정적 export (`next.config.ts`의 `output: "export"`)
- 스타일/애니메이션:
  - Tailwind CSS 4
  - Framer Motion
  - GSAP ScrollTrigger
  - Lenis (desktop only)
- 핵심 원칙:
  - 데이터는 정적 JSON 기반 (API/DB 없음)
  - 무거운 모션은 desktop + motion budget에서만
  - 모바일은 가시성/성능 우선 fallback 보장

## 2) Runtime/Bundling Constraints

- `next.config.ts`
  - `output: "export"`: 서버 런타임 기능/동적 API 의존 금지
  - `images.unoptimized: true`: `next/image` 최적화 off
  - `trailingSlash: true`: 링크/경로 처리 시 trailing slash 영향 고려
- 루트 레이아웃은 `src/app/layout.tsx`에서 CDN 폰트를 `<link>`로 로드
- App Router 구조이므로 페이지별 Server/Client 구분 엄수

## 3) Data Source of Truth

### Brand Catalog JSON

- 단일 진실 원천:
  - `src/data/brands/asics.json`
  - `src/data/brands/nike.json`
  - `src/data/brands/adidas.json`
- 현재 총 모델 수: 35
  - asics 12 / nike 12 / adidas 11

### Domain Types

- `src/types/shoe.ts`
  - `CategoryId`: `daily | super-trainer | racing`
  - `SubcategoryId`: 고정 enum 성격 (entry/max-cushion/.../full)
  - `RunningShoe`, `Brand`, `ShoeSpecs`
- `src/types/quiz.ts`
  - `QuizAnswer`는 단일 선택(`selectedOptionId`)
  - `ScoringCategory`는 스펙 축 + 카테고리 축 혼합

### Catalog Utilities

- `src/utils/shoe-utils.ts`
  - `getAllShoes()`는 원본 순서를 유지
  - 카테고리/브랜드 필터 함수들은 이름 기준 내림차순 정렬 인덱스 사용
  - `getAllBrandIds()`로 static params 생성
  - `getSimilarShoes(shoe, limit, { sameBrandFirst })` 제공
- `src/utils/brand-utils.ts`
  - 브랜드별 테마 컬러를 CSS 변수(`--color-asics-blue`, `--color-asics-accent`)로 매핑

## 4) Route Map (App Router)

- 홈: `/` -> `src/app/page.tsx`
- 퀴즈: `/quiz` -> `src/app/quiz/page.tsx`
- 브랜드 인덱스: `/brand` -> `src/app/brand/page.tsx`
- 브랜드 전체: `/brand/[brandId]` -> `src/app/brand/[brandId]/page.tsx`
- 브랜드 카테고리: `/brand/[brandId]/[category]` -> `src/app/brand/[brandId]/[category]/page.tsx`
- 신발 상세: `/shoe/[shoeId]` -> `src/app/shoe/[shoeId]/page.tsx`

### Static Params

- 브랜드 페이지: `getAllBrandIds()`
- 브랜드 카테고리 페이지: `getAllBrandIds() x categories`
- 신발 상세 페이지: `getAllShoes().map(shoe.slug)`

즉, 현재 라우트는 멀티브랜드 정적 생성 기준으로 동작한다.

## 5) Main Composition

홈(`src/app/page.tsx`) 섹션 순서:

1. `Header`
2. `HeroSection`
3. `CategoryNav`
4. `FeaturedShoes`
5. `QuizCTA`
6. `Footer`

### FeaturedShoes 주의사항

- 파일: `src/components/hero/FeaturedShoes.tsx`
- 데스크탑(>=1024): GSAP pin + horizontal scrub
- 모바일/태블릿: scroll-snap 캐러셀
- featured 목록은 현재 수동 ID 선택(ASICS 중심):
  - `novablast-5`, `superblast-2`, `metaspeed-sky-tokyo`, `gel-nimbus-28`, `magic-speed-5`
- 멀티브랜드 확장 시 여기 수동 선택 로직을 함께 갱신해야 한다.

## 6) Animation & Interaction Architecture

### Core Hooks

- `src/hooks/useIsDesktop.ts`
  - `useSyncExternalStore` 기반 미디어쿼리 store
  - 기본 브레이크포인트는 `MOBILE_BREAKPOINT=768`
  - 필요 시 `useIsDesktop(1024)`처럼 커스텀 사용

- `src/hooks/useInteractionCapabilities.ts`
  - 포인터 제약/데이터세이버 기반 `hasMotionBudget` 계산
  - 모션 허용 조건:
    - `!prefers-reduced-motion`
    - `!save-data`
    - `!coarse-pointer/touch`
  - 초기 스냅샷은 보수적으로 motion off 상태에서 시작 후 evaluate

- `src/hooks/useScrollVisibility.ts`
  - 헤더 hide/show 계산 (`isScrolled`, `isHidden`)
  - desktop에서만 활성화하는 패턴 사용

### GSAP Registration

- `src/lib/scroll-trigger.ts`의 `ensureScrollTriggerRegistration()`를 통해 1회 등록
- GSAP 사용하는 컴포넌트는 effect 내부에서 항상 이 함수 호출 후 트리거 생성

### CSS Initial State & Mobile Fallback

- 파일: `src/app/globals.css`
- desktop 전용 초기 숨김 상태(class 기반):
  - `.category-nav-header`, `.quiz-cta-container`, `.footer-link-item`, `.shoe-detail-pros`, `.shoe-detail-cons`
- 모바일 오버라이드로 해당 요소를 강제 visible 처리
- 이 패턴을 깨면 "모바일에서 요소가 안 보임" 회귀가 쉽게 발생한다.

## 7) Typography / Line-Break System

### Sentence-aware line breaks

- 컴포넌트: `src/components/common/SentenceLineBreakText.tsx`
- 알고리즘: `src/utils/sentence-linebreak.ts`
  - 한국어/영어 혼합 텍스트를 토큰화
  - 문장/절 단위 break strength 반영
  - line width cost 기반으로 mobile/desktop 줄바꿈 계획 생성
  - 결과 cache 사용

### 실무 규칙

- 마케팅 카피는 가능하면 `SentenceLineBreakText` 사용
- 픽셀 정밀 고정이 필요한 문장은 `desktopLines`/`mobileLines` 수동 지정
- 카드 등 좁은 폭에서 한글 중간 단어 분해(예: "쿠셔 / 닝")를 피하려면 `whitespace-nowrap`와 레이블 폭 점검

## 8) Quiz Flow

파일: `src/app/quiz/page.tsx`

- phase 상태:
  - `brand-select` -> `quiz` -> `analyzing` -> `result`
- 브랜드 선호(localStorage `runpick.preferredBrand`) 반영 가능
- 마지막 질문 후 0.9s 분석 단계 후 결과 계산

### Scoring

- 파일: `src/utils/quiz-logic.ts`
- 점수 공식:
  - 40% attribute match
  - 40% category match
  - 20% experience bonus
- 결과 percent는 60~98로 clamp
- 브랜드 선호가 있으면 해당 브랜드 필터 우선 적용

## 9) Brand / Detail Page Behavior

### Brand pages

- `BrandPageClient.tsx`
  - 브랜드별 카테고리 섹션 집계 렌더
  - 고정 카테고리 네비 + 헤더 hide/show 연동
  - `BrandSwitcher`로 브랜드 간 점프

- `CategoryPageClient.tsx`
  - 서브카테고리 필터 탭 + `AnimatePresence` 레이아웃 전환
  - 모바일에서 탭 선택 시 목록 영역으로 스무스 스크롤

### Shoe detail

- `ShoeDetailClient.tsx`
  - 슬러그 기반 조회
  - pros/cons는 desktop GSAP reveal
  - 유사 모델은 `getSimilarShoes(..., { sameBrandFirst: true })`

## 10) Generated / Scripted Artifacts

- 이미지 매니페스트 생성:
  - script: `scripts/generate-image-manifest.mjs`
  - output: `src/data/image-manifest.ts` (자동 생성 파일)
  - `predev`, `prebuild`에서 자동 실행
- 카탈로그 검증:
  - `scripts/validate-catalog.mjs`
  - brand/category/subcategory/id/slug/image 유효성 검사

### 수정 원칙

- `src/data/image-manifest.ts`는 수동 편집 금지
- 이미지/JSON 변경 후 build 또는 script 실행으로 최신화 유지

## 11) Known Gotchas

- `npm run lint`는 현재 스크립트(`next lint`)가 Next 16 환경에서 디렉토리 인자 오인식으로 실패할 수 있음
- `src/components/common/PageTransition.tsx`는 현재 미사용(실사용은 `src/components/layout/PageTransition.tsx`)
- 커스텀 커서/마그네틱/이미지 왜곡은 motion budget에 강하게 의존
- 홈 featured 섹션은 데이터 자동 선정이 아니라 수동 ID 기반이라 신규 브랜드 자동 반영되지 않음

## 12) Change Playbook

### A. 새 브랜드 추가

1. `src/data/brands/<brand>.json` 추가
2. `shoe-utils.ts`의 brand import 배열에 추가
3. `brand-utils.ts` 테마 컬러 매핑 추가
4. `public/shoes` 이미지 추가
5. `npm run validate:catalog`
6. `npm run build`

### B. 신발 모델 추가

1. 해당 브랜드 JSON에 모델 객체 추가
2. `id/slug` 중복 없는지 확인
3. 카테고리/서브카테고리 enum과 일치 확인
4. 이미지 파일 배치
5. build로 static params 반영 확인

### C. 홈 문구/줄바꿈 수정

1. 텍스트 컴포넌트 위치 확인(`HeroSection`, `CategoryNav`, `QuizCTA`, `Footer`)
2. `SentenceLineBreakText`로 자동 혹은 수동 lines 설정
3. 데스크탑/모바일 모두에서 실제 줄바꿈 확인

### D. 스크롤/애니메이션 수정

1. desktop 가드(`useIsDesktop`, `hasMotionBudget`) 유지
2. GSAP cleanup 누락 금지
3. `globals.css` mobile visible override가 필요한지 함께 점검

## 13) Practical QA Checklist

변경 후 최소 확인:

1. 데스크탑
  - 헤더 hide/show
  - 홈 Featured horizontal pin 시작 시점/가시성
  - 브랜드/카테고리 고정 탭 위치
2. 모바일
  - 모든 섹션이 실제로 렌더되는지(숨김 고정 없음)
  - 가로 스크롤 구간에서 카드 텍스트 잘림 여부
  - 퀴즈 하단 고정 CTA 동작
3. 공통
  - `/brand`, `/brand/[brandId]`, `/brand/[brandId]/[category]`, `/shoe/[shoeId]` 진입
  - 이미지 fallback 배지 노출
  - localStorage 선호 브랜드 연동

## 14) Commands

```bash
npm run dev
npm run build
npm run validate:catalog
```

`npm run lint`는 현재 환경에서 신뢰성 이슈가 있어, 필요하면 별도 eslint 실행 방식을 정비 후 사용한다.
